<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Patient Creation Form - PAmazeCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
            background: var(--gray-50);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .test-header {
            background: var(--primary-color);
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }
        
        .test-header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
        }
        
        .test-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .test-content {
            padding: 2rem;
        }
        
        .test-button {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto;
        }
        
        .test-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-container.active {
            display: flex;
        }
        
        .api-status {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .api-status.success {
            background: var(--gray-100);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .api-status.error {
            background: var(--gray-100);
            color: var(--error);
            border: 1px solid var(--error);
        }
        
        .instructions {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
        }
        
        .instructions h3 {
            margin: 0 0 1rem 0;
            color: var(--gray-800);
        }
        
        .instructions ol {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .instructions li {
            margin-bottom: 0.5rem;
            color: var(--gray-600);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1><i class="fas fa-heartbeat"></i> PAmazeCare</h1>
            <p>Patient Creation Form Test</p>
        </div>
        
        <div class="test-content">
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Testing Instructions</h3>
                <ol>
                    <li>Make sure your backend server is running on <strong>http://localhost:5120</strong></li>
                    <li>Click the "Add New Patient" button below</li>
                    <li>Fill out the patient form with valid information</li>
                    <li>Click "Save Patient" to test the API integration</li>
                    <li>Check the console for any errors or success messages</li>
                </ol>
            </div>
            
            <div style="text-align: center;">
                <button class="test-button" onclick="showAddPatient()">
                    <i class="fas fa-user-plus"></i>
                    Add New Patient
                </button>
            </div>
            
            <div id="apiStatus" class="api-status" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer" class="modal-container">
        <!-- Patient form modal will be inserted here -->
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <i class="notification-icon"></i>
            <span class="notification-message"></span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="api.js"></script>
    
    <script>
        // Simple test application class
        class TestApp {
            constructor() {
                this.init();
            }
            
            init() {
                console.log('Test app initialized');
                console.log('API Base URL:', API_BASE_URL);
            }
            
            showModal(htmlContent) {
                const container = document.getElementById('modalContainer');
                container.innerHTML = htmlContent;
                container.classList.add('active');
            }
            
            closeModal() {
                const container = document.getElementById('modalContainer');
                container.classList.remove('active');
                container.innerHTML = '';
            }
            
            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const messageEl = notification.querySelector('.notification-message');
                const iconEl = notification.querySelector('.notification-icon');
                
                messageEl.textContent = message;
                notification.className = `notification ${type}`;
                
                // Set appropriate icon
                let iconClass = 'fas fa-info-circle';
                if (type === 'success') iconClass = 'fas fa-check-circle';
                else if (type === 'error') iconClass = 'fas fa-exclamation-circle';
                else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
                
                iconEl.className = iconClass;
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
            
            showApiStatus(message, isSuccess) {
                const statusEl = document.getElementById('apiStatus');
                statusEl.textContent = message;
                statusEl.className = `api-status ${isSuccess ? 'success' : 'error'}`;
                statusEl.style.display = 'block';
            }
            
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            togglePasswordVisibility(inputId) {
                const input = document.getElementById(inputId);
                const toggleBtn = input.parentElement.querySelector('.password-toggle i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    toggleBtn.className = 'fas fa-eye-slash';
                } else {
                    input.type = 'password';
                    toggleBtn.className = 'fas fa-eye';
                }
            }
            
            async showAddPatient() {
                const modalHtml = `
                    <div class="modal">
                        <div class="modal-header">
                            <h2><i class="fas fa-user-plus"></i> Add New Patient</h2>
                            <button class="modal-close" onclick="testApp.closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addPatientForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="patientFullName">Full Name *</label>
                                        <div class="input-group">
                                            <i class="fas fa-user"></i>
                                            <input type="text" id="patientFullName" name="fullName" required 
                                                   placeholder="Enter patient's full name" minlength="2">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="patientEmail">Email Address *</label>
                                        <div class="input-group">
                                            <i class="fas fa-envelope"></i>
                                            <input type="email" id="patientEmail" name="email" required 
                                                   placeholder="Enter email address">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="patientPassword">Password *</label>
                                        <div class="input-group">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" id="patientPassword" name="password" required 
                                                   placeholder="Enter password" minlength="6">
                                            <button type="button" class="password-toggle" onclick="testApp.togglePasswordVisibility('patientPassword')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="patientContact">Contact Number</label>
                                        <div class="input-group">
                                            <i class="fas fa-phone"></i>
                                            <input type="tel" id="patientContact" name="contactNumber" 
                                                   placeholder="Enter contact number" pattern="[0-9]{10}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="patientDOB">Date of Birth *</label>
                                        <div class="input-group">
                                            <i class="fas fa-calendar"></i>
                                            <input type="date" id="patientDOB" name="dateOfBirth" required 
                                                   max="${new Date().toISOString().split('T')[0]}">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="testApp.closeModal()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-primary" onclick="testApp.savePatient()">
                                <i class="fas fa-save"></i> Save Patient
                            </button>
                        </div>
                    </div>
                `;
                this.showModal(modalHtml);
            }
            
            async savePatient() {
                try {
                    const form = document.getElementById('addPatientForm');
                    
                    // Validate form
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const formData = new FormData(form);
                    
                    // Additional validation
                    const fullName = formData.get('fullName')?.trim();
                    const email = formData.get('email')?.trim();
                    const password = formData.get('password');
                    const contactNumber = formData.get('contactNumber')?.trim();
                    const dateOfBirth = formData.get('dateOfBirth');

                    if (!fullName || fullName.length < 2) {
                        this.showNotification('Full name must be at least 2 characters long', 'error');
                        return;
                    }

                    if (!email || !this.isValidEmail(email)) {
                        this.showNotification('Please enter a valid email address', 'error');
                        return;
                    }

                    if (!password || password.length < 6) {
                        this.showNotification('Password must be at least 6 characters long', 'error');
                        return;
                    }

                    if (!dateOfBirth) {
                        this.showNotification('Date of birth is required', 'error');
                        return;
                    }

                    // Check if patient is at least 1 year old
                    const birthDate = new Date(dateOfBirth);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    if (age < 1 || birthDate > today) {
                        this.showNotification('Please enter a valid date of birth', 'error');
                        return;
                    }

                    this.showLoading(true);

                    const patientDto = {
                        fullName: fullName,
                        email: email,
                        password: password,
                        contactNumber: contactNumber || null,
                        dateOfBirth: dateOfBirth
                    };

                    console.log('Sending patient data:', patientDto);
                    
                    const result = await apiService.createPatient(patientDto);
                    
                    console.log('Patient creation result:', result);
                    
                    this.showNotification('Patient added successfully!', 'success');
                    this.showApiStatus('✅ Patient created successfully! Check console for details.', true);
                    this.closeModal();
                    
                } catch (error) {
                    console.error('Error saving patient:', error);
                    let errorMessage = 'Error saving patient';
                    
                    if (error.message.includes('400')) {
                        errorMessage = 'Invalid patient data. Please check all fields.';
                    } else if (error.message.includes('409')) {
                        errorMessage = 'A patient with this email already exists.';
                    } else if (error.message.includes('500')) {
                        errorMessage = 'Server error. Please try again later.';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage = 'Cannot connect to server. Make sure the backend is running on http://localhost:5120';
                    }
                    
                    this.showNotification(errorMessage, 'error');
                    this.showApiStatus(`❌ Error: ${errorMessage}`, false);
                } finally {
                    this.showLoading(false);
                }
            }
        }
        
        // Initialize test app
        const testApp = new TestApp();
        
        // Global functions for onclick handlers
        function showAddPatient() {
            testApp.showAddPatient();
        }
    </script>
</body>
</html>
